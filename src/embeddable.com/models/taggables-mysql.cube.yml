cubes:
  - name: taggables_mysql
    title: "Taggables (MySQL)"
    data_source: mysql
    sql: >
      SELECT
        taggables.tag_id,
        taggables.taggable_id,
        taggables.taggable_type
      FROM taggables
        INNER JOIN tags
          ON taggables.tag_id = tags.id
            AND tags.account_id = '{ COMPILE_CONTEXT.securityContext.accountId }'
      WHERE taggables.taggable_type IN (
        'AwardForce\\\\Modules\\\\Entries\\\\Models\\\\Entry',
        'AwardForce\\\\Modules\\\\GrantReports\\\\Models\\\\GrantReport',
        'AwardForce\\\\Modules\\\\Funding\\\\Data\\\\Allocation'
      )

    joins:
      - name: tags_mysql
        sql: "{CUBE}.tag_id = {tags_mysql}.id"
        relationship: many_to_one

    dimensions:
      - name: id
        sql: "CONCAT(tag_id, '_', taggable_id, '_', taggable_type)"
        type: string
        primary_key: true

      - name: taggable_type
        type: string
        case:
          when:
            - sql: taggable_type = 'AwardForce\\\\Modules\\\\Entries\\\\Models\\\\Entry'
              label: Entry
            - sql: taggable_type = 'AwardForce\\\\Modules\\\\GrantReports\\\\Models\\\\GrantReport'
              label: Grant report
            - sql: taggable_type = 'AwardForce\\\\Modules\\\\Funding\\\\Data\\\\Allocation'
              label: Allocation
          else:
            label: Other

    measures:
      - name: count
        type: count
        title: 'Qty taggables'
